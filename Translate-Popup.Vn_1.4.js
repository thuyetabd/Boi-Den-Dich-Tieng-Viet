// ==UserScript==
// @name         D·ªãch T·ª´ B√¥i ƒêen
// @namespace    https://tampermonkey.net/
// @version      1.4
// @description  D·ªãch nhanh vƒÉn b·∫£n b√¥i ƒëen
// @author       Phan ƒê√¨nh Thuy·∫øt
// @license      MIT
// @match        http://*/*
// @match        https://*/*
// @grant        GM_addStyle
// @grant        GM_xmlhttpRequest
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// @connect      translate.googleapis.com
// @connect      generativelanguage.googleapis.com
// ==/UserScript==

(()=>{'use strict';
const LANG_PRESET=[{code:'vi',label:'Ti·∫øng Vi·ªát'},{code:'en',label:'English'},{code:'ko',label:'ÌïúÍµ≠Ïñ¥'},{code:'ja',label:'Êó•Êú¨Ë™û'}];
const GEMINI_MODELS=['gemini-2.5-flash-preview-04-17','gemini-2.0-flash-live-001','gemini-2.0-flash-lite','gemini-2.0-flash-exp','gemini-2.0-flash'];
let icon,icon2,popup,content,selectedText=GM_getValue('lastSel',''),targetLang=GM_getValue('lang','vi'),secondLang=GM_getValue('lang2','en'),useGemini=GM_getValue('useGemini',false),geminiKey=GM_getValue('geminiKey',''),geminiModel=GM_getValue('geminiModel',GEMINI_MODELS[0]),currentLang=targetLang,lastTranslation='';
const esc=s=>s.replace(/[&<>"']/g,c=>({'&':'&','<':'<','>':'>','"':'"','\'':'\''}[c]));
const qs=(sel,el=document)=>el.querySelector(sel);
const translateGoogle=(t,cb)=>{GM_xmlhttpRequest({method:'GET',url:`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${currentLang}&dt=t&q=${encodeURIComponent(t)}`,onload:r=>{if(r.status!==200)return cb(Error(r.status));try{cb(null,JSON.parse(r.responseText)[0].map(s=>s[0]).join(''));}catch(e){cb(e);}},onerror:cb});};
const translateGemini=(t,cb)=>{if(!geminiKey)return cb(Error('no_key'));const prompt=`Please translate the following text into the target language (ISO: ${currentLang}) in a natural, concise manner while preserving the original structure. Do not add any extra commentary.\n\n${t}`;GM_xmlhttpRequest({method:'POST',url:`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiKey}`,headers:{'Content-Type':'application/json'},data:JSON.stringify({contents:[{parts:[{text:prompt}]}]}),onload:r=>{if(r.status!==200)return cb(Error(r.status));try{cb(null,JSON.parse(r.responseText).candidates[0].content.parts[0].text);}catch(e){cb(e);}},onerror:cb});};
const translate=(t,c)=>(useGemini?translateGemini:translateGoogle)(t,c);
GM_addStyle(`#qt-icon,#qt-icon2{position:fixed;z-index:2147483646;cursor:pointer;font-size:18px;padding:4px 7px;background:#fff3;border:1px solid #555;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.4);user-select:none;display:none}#qt-icon:hover,#qt-icon2:hover{background:#fff6}#qt-popup{position:fixed;z-index:2147483647;min-width:280px;max-width:520px;max-height:380px;padding:48px 24px 24px;background:#1e1e1e;border:1px solid #555;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.7);font:600 16px/1.5 'Segoe UI',sans-serif;color:#f5f5f5;overflow:auto;display:none;opacity:0;transform:translateY(10px) scale(.96);transition:opacity .25s,transform .25s}#qt-popup::before{content:'';position:absolute;top:0;left:0;width:100%;height:40px;border-top-left-radius:12px;border-top-right-radius:12px;background:linear-gradient(135deg,#3a3a3a,#2a2a2a)}#qt-paste-btn{position:absolute;top:6px;right:42px;padding:4px 8px;font-size:14px;border:1px solid #666;border-radius:6px;background:#007BFF;color:#fff;cursor:pointer}#qt-paste-btn:hover{background:#0069d9}#qt-close{position:absolute;top:4px;right:6px;font-size:22px;cursor:pointer;color:#eee}#qt-close:hover{color:#ff6b6b}#qt-popup.show{opacity:1;transform:translateY(0) scale(1)}.qt-loading{color:#aaa;font-style:italic}.qt-error{color:#ff6b6b;font-weight:bold}.qt-text{white-space:pre-wrap;word-wrap:break-word}#qt-back{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:2147483646}#qt-box{background:#111;border:1px solid #444;border-radius:10px;padding:22px 28px;min-width:300px;box-shadow:0 8px 18px rgba(0,0,0,.6);display:flex;flex-direction:column;gap:10px;color:#f5f5f5;font-family:'Segoe UI',sans-serif}#qt-box h3{margin:0 0 6px;font-size:18px;text-align:center}.qt-row{display:flex;align-items:center;gap:12px}.qt-row label{min-width:100px;font-size:14px;color:#ccc}.qt-row input,.qt-row select{flex:1;padding:6px 8px;font-size:14px;background:#222;border:1px solid #555;color:#f5f5f5;border-radius:6px}.qt-lang-btn{margin:6px 4px 0;padding:6px 12px;font-size:15px;border:1px solid #555;border-radius:6px;background:#222;color:#f5f5f5;cursor:pointer}.qt-lang-btn.active{background:#4caf50;border-color:#4caf50;color:#fff}#qt-save{margin-top:14px;align-self:flex-end;background:#4caf50;color:#fff;border:none;padding:8px 14px;font-size:15px;border-radius:6px;cursor:pointer}#qt-save:hover{background:#45a648}.qt-paste{margin-top:12px;display:inline-block;padding:6px 12px;font-size:14px;border:1px solid #555;border-radius:6px;background:#333;color:#f5f5f5;cursor:pointer}.qt-paste:hover{background:#444}`);
const ensureIcons=()=>{if(icon)return;icon=document.createElement('div');icon.id='qt-icon';icon.textContent='üåê';icon2=document.createElement('div');icon2.id='qt-icon2';icon2.textContent='üÖ∞';document.body.append(icon,icon2);icon.onclick=e=>{e.stopPropagation();if(!targetLang)return;if(selectedText){currentLang=targetLang;openPopup();}hideIcons();};icon2.onclick=e=>{e.stopPropagation();if(!secondLang)return;if(selectedText){currentLang=secondLang;openPopup();}hideIcons();};updateIconVisibility();};
const ensurePopup=()=>{if(popup)return;popup=document.createElement('div');popup.id='qt-popup';const close=document.createElement('span');close.id='qt-close';close.textContent='√ó';close.onclick=closePopup;content=document.createElement('div');popup.append(close,content);document.body.appendChild(popup);};
const iconGap=38;const showIcons=(x,y)=>{ensureIcons();updateIconVisibility();const arr=[];if(targetLang)arr.push(icon);if(secondLang)arr.push(icon2);arr.forEach((ic,i)=>{ic.style.left=(x+i*iconGap)+'px';ic.style.top=y+'px';});};
const hideIcons=()=>{if(icon){icon.style.display='none';icon2.style.display='none';}};
const openPopup=()=>{ensurePopup();popup.style.left='50%';popup.style.top='50%';popup.style.transform='translate(-50%,-50%)';popup.style.display='block';requestAnimationFrame(()=>popup.classList.add('show'));render();};
const closePopup=()=>{if(!popup)return;popup.classList.remove('show');setTimeout(()=>{popup.style.display='none';},250);};
const render=()=>{content.innerHTML='<span class="qt-loading">ƒêang d·ªãch...</span>';translate(selectedText,(e,res)=>{if(e||!res){content.innerHTML='<span class="qt-error">Kh√¥ng th·ªÉ d·ªãch.</span>';return;}lastTranslation=res;content.innerHTML=`<span class="qt-text">${esc(res)}</span>`;let btn=document.getElementById('qt-paste-btn');if(!btn){btn=document.createElement('button');btn.id='qt-paste-btn';btn.textContent='üìã';btn.title='Paste translation';btn.onclick=pasteTranslation;popup.appendChild(btn);}});};
const pasteTranslation=()=>{if(!lastTranslation)return;const sel=window.getSelection();if(!sel.rangeCount)return;const range=sel.getRangeAt(0);range.deleteContents();range.insertNode(document.createTextNode(lastTranslation));sel.removeAllRanges();closePopup();hideIcons();};
let back;const ensureSettings=()=>{if(back)return;back=document.createElement('div');back.id='qt-back';back.style.display='none';const box=document.createElement('div');box.id='qt-box';back.appendChild(box);box.innerHTML=`<span id="qt-close-set" style="position:absolute;top:6px;right:10px;font-size:22px;cursor:pointer">√ó</span><h3>Thi·∫øt l·∫≠p d·ªãch</h3><div class="qt-row"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="qt-use"> D√πng Gemini</label></div><div class="qt-row"><label>API Key</label><input id="qt-key" placeholder="Gemini API key"></div><div class="qt-row"><label>Model</label><select id="qt-model"></select></div><hr style="width:100%;height:1px;background:#444;border:none"><div class="qt-row"><label>Ng√¥n ng·ªØ 1</label><div id="qt-lang"></div></div><div class="qt-row"><label>M√£ ISO 1</label><input id="qt-iso"></div><div class="qt-row"><label>Ng√¥n ng·ªØ 2</label><div id="qt-lang2"></div></div><div class="qt-row"><label>M√£ ISO 2</label><input id="qt-iso2"></div><button id="qt-save">L∆∞u</button>`;document.body.appendChild(back);GEMINI_MODELS.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;qs('#qt-model',box).appendChild(o);});LANG_PRESET.forEach(l=>{const b=document.createElement('button');b.className='qt-lang-btn';b.dataset.code=l.code;b.textContent=l.label;qs('#qt-lang',box).appendChild(b);});LANG_PRESET.forEach(l=>{const b=document.createElement('button');b.className='qt-lang-btn';b.dataset.code=l.code;b.textContent=l.label;qs('#qt-lang2',box).appendChild(b.cloneNode(true));});qs('#qt-close-set',box).onclick=()=>{back.style.display='none';};back.onclick=e=>{if(e.target===back)back.style.display='none';};qs('#qt-save',box).onclick=()=>{useGemini=qs('#qt-use',box).checked;geminiKey=qs('#qt-key',box).value.trim();geminiModel=qs('#qt-model',box).value;GM_setValue('useGemini',useGemini);GM_setValue('geminiKey',geminiKey);GM_setValue('geminiModel',geminiModel);GM_setValue('lang',targetLang);GM_setValue('lang2',secondLang);back.style.display='none';updateIconVisibility();};const btns1=box.querySelectorAll('#qt-lang .qt-lang-btn'),btns2=box.querySelectorAll('#qt-lang2 .qt-lang-btn');const mark=()=>btns1.forEach(b=>b.classList.toggle('active',b.dataset.code===targetLang)),mark2=()=>btns2.forEach(b=>b.classList.toggle('active',b.dataset.code===secondLang));qs('#qt-lang',box).onclick=e=>{if(e.target.classList.contains('qt-lang-btn')){targetLang=e.target.dataset.code;qs('#qt-iso',box).value=targetLang;mark();}};qs('#qt-iso',box).oninput=e=>{targetLang=e.target.value.trim();mark();updateIconVisibility();};qs('#qt-lang2',box).onclick=e=>{if(e.target.classList.contains('qt-lang-btn')){secondLang=e.target.dataset.code;qs('#qt-iso2',box).value=secondLang;mark2();}};qs('#qt-iso2',box).oninput=e=>{secondLang=e.target.value.trim();mark2();updateIconVisibility();};qs('#qt-use',box).onchange=()=>updateGeminiFields();const updateGeminiFields=()=>{const dis=!qs('#qt-use',box).checked;qs('#qt-key',box).disabled=dis;qs('#qt-model',box).disabled=dis;qs('#qt-key',box).style.opacity=qs('#qt-model',box).style.opacity=dis?0.5:1;};qs('#qt-use',box).checked=useGemini;qs('#qt-key',box).value=geminiKey;qs('#qt-model',box).value=geminiModel;qs('#qt-iso',box).value=targetLang;qs('#qt-iso2',box).value=secondLang;mark();mark2();updateGeminiFields();};GM_registerMenuCommand('C√†i ƒë·∫∑t D·ªãch‚Ä¶',()=>{ensureSettings();back.style.display='flex';});
document.addEventListener('mouseup',e=>{if(icon?.contains(e.target)||popup?.contains(e.target))return;const sel=window.getSelection();setTimeout(()=>{const txt=sel.toString().trim();if(txt){selectedText=txt;GM_setValue('lastSel',txt);const pad=10,w=90,h=30;let x=Math.min(e.clientX+pad,innerWidth-w-pad),y=Math.min(e.clientY+30,innerHeight-h-30);x=Math.max(pad,x);y=Math.max(30,y);showIcons(x,y);}else hideIcons();});});document.addEventListener('mousedown',e=>{if(!icon?.contains(e.target)&&!icon2?.contains(e.target)&&!popup?.contains(e.target)){hideIcons();closePopup();}});
const updateIconVisibility=()=>{if(!icon)return;icon.style.display=targetLang?'block':'none';icon2.style.display=secondLang?'block':'none';};})(); 
